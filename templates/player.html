<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEO AUDIO | Modern MP3 Player</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-tertiary: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --accent-primary: #1db954;
            --accent-secondary: #535353;
            --error: #e74c3c;
            --success: #2ecc71;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--accent-secondary);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: var(--accent-primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .logo-text {
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .network-info {
            background: var(--bg-secondary);
            padding: 8px 15px;
            border-radius: 30px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .network-info i {
            margin-right: 8px;
        }

        .player-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        @media (max-width: 900px) {
            .player-grid {
                grid-template-columns: 1fr;
            }
        }

        .player-card {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--accent-secondary);
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .audio-info, .songs-count {
            font-size: 0.9rem;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            padding: 5px 12px;
            border-radius: 20px;
        }

        .now-playing {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .album-art {
            width: 220px;
            height: 220px;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 25px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            background-size: cover;
            background-position: center;
        }

        .album-art i {
            font-size: 5rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .song-info {
            text-align: center;
            margin-bottom: 25px;
            width: 100%;
        }

        .song-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 20px;
        }

        .song-artist {
            font-size: 1.2rem;
            color: var(--text-secondary);
        }

        .progress-container {
            width: 100%;
            margin-bottom: 25px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
            cursor: pointer;
            margin-bottom: 8px;
        }

        .progress {
            height: 100%;
            background: var(--accent-primary);
            width: 0%;
            border-radius: 3px;
            transition: width 0.1s linear;
        }

        .time-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.2rem;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .control-btn:hover {
            background: var(--bg-tertiary);
        }

        .play-btn {
            width: 70px;
            height: 70px;
            background: var(--accent-primary);
            font-size: 1.8rem;
        }

        .play-btn.playing {
            background: #e74c3c;
        }

        .play-btn:hover {
            transform: scale(1.05);
            background: #1ed760;
        }

        .volume-container {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
            max-width: 300px;
            margin-top: 20px;
        }

        .volume-slider {
            flex: 1;
            height: 5px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--bg-tertiary);
            border-radius: 5px;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--text-primary);
            cursor: pointer;
        }

        .playlist-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
        }

        .playlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .playlist-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .playlist-actions {
            display: flex;
            gap: 10px;
        }

        .playlist-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
            overflow-y: auto;
            max-height: 150px;
        }

        .playlist-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            gap: 12px;
        }

        .playlist-item:hover {
            background: #333;
        }

        .playlist-item.active {
            background: rgba(29, 185, 84, 0.2);
            border-left: 3px solid var(--accent-primary);
        }

        .playlist-item-image {
            width: 40px;
            height: 40px;
            border-radius: 5px;
            background-size: cover;
            background-position: center;
            background-color: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .playlist-item-image i {
            opacity: 0.7;
        }

        .playlist-item-info {
            flex: 1;
            min-width: 0;
        }

        .playlist-item-name {
            font-weight: 500;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-item-track-count {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .tracks-container {
            flex-grow: 1;
            overflow-y: auto;
            border-radius: 10px;
            background: var(--bg-tertiary);
        }

        .track-list {
            display: flex;
            flex-direction: column;
        }

        .track-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            gap: 15px;
            border-bottom: 1px solid var(--accent-secondary);
            transition: var(--transition);
        }

        .track-item:last-child {
            border-bottom: none;
        }

        .track-item:hover {
            background: var(--bg-secondary);
        }

        .track-item.active {
            background: rgba(29, 185, 84, 0.1);
        }

        .track-item-art {
            width: 40px;
            height: 40px;
            background: var(--bg-secondary);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .track-item-info {
            flex: 1;
            min-width: 0;
        }

        .track-item-title {
            font-weight: 500;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-item-artist {
            font-size: 0.9rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-item-duration {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin: 0 15px;
        }

        .track-item-actions {
            display: flex;
            gap: 10px;
        }

        .action-icon {
            background: rgba(255, 255, 255, 0.1);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .action-icon:hover {
            background: var(--accent-primary);
            transform: scale(1.1);
        }

        .folder-scanner {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .scanner-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--accent-secondary);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--text-secondary);
        }

        .status-dot.scanning {
            background: #f39c12;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .audio-files {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .file-card {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 20px;
            transition: var(--transition);
        }

        .file-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .file-icon {
            width: 60px;
            height: 60px;
            background: var(--accent-primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .file-name {
            font-weight: 600;
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-info {
            display: flex;
            justify-content: space-between;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .add-to-playlist {
            width: 100%;
            background: rgba(29, 185, 84, 0.2);
            border: none;
            color: var(--accent-primary);
            padding: 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .add-to-playlist:hover {
            background: rgba(29, 185, 84, 0.3);
        }

        .player-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .action-btn {
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .action-btn:hover {
            background: var(--accent-secondary);
        }

        .mode-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 15px;
        }

        .mode-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .mode-btn.active {
            color: var(--accent-primary);
        }

        .drag-handle {
            cursor: move;
            opacity: 0.3;
            padding: 0 10px;
        }

        .track-item.dragging {
            opacity: 0.5;
            border: 1px dashed var(--accent-primary);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .modal-body {
            margin-bottom: 25px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .image-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
        }

        .image-preview {
            width: 150px;
            height: 150px;
            border-radius: 10px;
            background: var(--bg-tertiary);
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .image-preview i {
            font-size: 3rem;
            color: var(--text-secondary);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 30px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        footer {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            border-top: 1px solid var(--accent-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-music"></i>
                </div>
                <div class="logo-text">NEO AUDIO</div>
            </div>
            <div class="network-info">
                <i class="fas fa-wifi"></i>
                <span id="networkAddress">Accessible at: 192.168.1.5:5000</span>
            </div>
        </header>

        <div class="player-grid">
            <div class="player-card">
                <div class="player-header">
                    <div class="section-title">Now Playing</div>
                    <div class="audio-info">MP3 • 320kbps</div>
                </div>
                
                <div class="now-playing">
                    <div class="album-art" id="albumArt">
                        <i class="fas fa-music"></i>
                    </div>
                    
                    <div class="song-info">
                        <div class="song-title" id="currentSongTitle">Select a song to play</div>
                        <div class="song-artist" id="currentSongArtist"></div>
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-bar" id="progressBarContainer">
                            <div class="progress" id="progressBar"></div>
                        </div>
                        <div class="time-info">
                            <span id="currentTime">0:00</span>
                            <span id="duration">0:00</span>
                        </div>
                    </div>
                    
                    <div class="controls">
                        <button class="control-btn" id="shuffleBtn">
                            <i class="fas fa-random"></i>
                        </button>
                        <button class="control-btn" id="prevBtn">
                            <i class="fas fa-step-backward"></i>
                        </button>
                        <button class="control-btn play-btn" id="playBtn">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="control-btn" id="nextBtn">
                            <i class="fas fa-step-forward"></i>
                        </button>
                        <button class="control-btn" id="repeatBtn">
                            <i class="fas fa-repeat"></i>
                        </button>
                    </div>
                    
                    <div class="mode-controls">
                        <button class="mode-btn" id="repeatNoneBtn" title="No repeat">
                            <i class="fas fa-ban"></i>
                        </button>
                        <button class="mode-btn" id="repeatOneBtn" title="Repeat one">
                            <i class="fas fa-repeat-1"></i>
                        </button>
                        <button class="mode-btn" id="repeatAllBtn" title="Repeat all">
                            <i class="fas fa-infinity"></i>
                        </button>
                    </div>
                    
                    <div class="volume-container">
                        <i class="fas fa-volume-down"></i>
                        <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.01" value="0.7">
                        <i class="fas fa-volume-up"></i>
                    </div>
                </div>
            </div>
            
            <div class="player-card">
                <div class="player-header">
                    <div class="section-title">Playlists</div>
                    <div class="songs-count"><span id="playlistCount">0</span> playlists</div>
                </div>
                
                <div class="player-actions">
                    <button class="action-btn" id="createPlaylistBtn">
                        <i class="fas fa-plus"></i> New Playlist
                    </button>
                </div>
                
                <div class="playlist-container">
                    <div class="playlist-header">
                        <div class="playlist-title" id="currentPlaylistName">Select a playlist</div>
                        <div class="playlist-actions">
                            <div class="action-icon" id="renamePlaylistBtn" title="Rename Playlist">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div class="action-icon" id="deletePlaylistBtn" title="Delete Playlist">
                                <i class="fas fa-trash"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="playlist-list" id="playlistList">
                        <!-- Playlists will be populated by JavaScript -->
                    </div>
                    
                    <div class="player-actions">
                        <button class="action-btn" id="addAllBtn">
                            <i class="fas fa-plus"></i> Add All
                        </button>
                        <button class="action-btn" id="clearPlaylistBtn">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                    </div>
                    
                    <div class="tracks-container">
                        <div class="track-list" id="tracksContainer">
                            <!-- Tracks will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="folder-scanner">
            <div class="scanner-header">
                <div class="section-title">Audio Library</div>
                <div class="status-indicator">
                    <div class="status-dot" id="scanStatusDot"></div>
                    <span id="scanStatusText">Scanning folder...</span>
                </div>
            </div>
            
            <div class="audio-files" id="audioLibrary">
                <!-- Audio library will be populated by JavaScript -->
            </div>
        </div>
        
        <footer>
            <p>NEO AUDIO Player • Accessible on your local network • Scans for MP3, WAV, FLAC files</p>
        </footer>
    </div>

    <!-- Playlist Modal -->
    <div class="modal" id="playlistModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">New Playlist</div>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="playlistName">Playlist Name</label>
                    <input type="text" id="playlistName" placeholder="Enter playlist name">
                </div>
                
                <div class="image-upload">
                    <div class="image-preview" id="imagePreview">
                        <i class="fas fa-image"></i>
                    </div>
                    <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                    <button class="btn btn-secondary" id="uploadImageBtn">Upload Image</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelModalBtn">Cancel</button>
                <button class="btn btn-primary" id="savePlaylistBtn">Save</button>
            </div>
        </div>
    </div>

    <script>
        // Audio player and state management
        document.addEventListener('DOMContentLoaded', function() {
            const audio = new Audio();
            let currentTrack = null;
            let currentTrackIndex = -1;
            let audioFiles = [];
            let playlists = [];
            let currentPlaylistId = null;
            let playerState = {
                shuffle: false,
                repeat: 'none', // none, one, all
                volume: 0.7,
                playbackState: 'paused'
            };
            
            // DOM Elements
            const playBtn = document.getElementById('playBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const shuffleBtn = document.getElementById('shuffleBtn');
            const repeatBtn = document.getElementById('repeatBtn');
            const progressBar = document.getElementById('progressBar');
            const progressBarContainer = document.getElementById('progressBarContainer');
            const currentTimeDisplay = document.getElementById('currentTime');
            const durationDisplay = document.getElementById('duration');
            const volumeSlider = document.getElementById('volumeSlider');
            const currentSongTitle = document.getElementById('currentSongTitle');
            const currentSongArtist = document.getElementById('currentSongArtist');
            const albumArt = document.getElementById('albumArt');
            const playlistList = document.getElementById('playlistList');
            const tracksContainer = document.getElementById('tracksContainer');
            const audioLibrary = document.getElementById('audioLibrary');
            const playlistCount = document.getElementById('playlistCount');
            const addAllBtn = document.getElementById('addAllBtn');
            const clearPlaylistBtn = document.getElementById('clearPlaylistBtn');
            const createPlaylistBtn = document.getElementById('createPlaylistBtn');
            const renamePlaylistBtn = document.getElementById('renamePlaylistBtn');
            const deletePlaylistBtn = document.getElementById('deletePlaylistBtn');
            const repeatNoneBtn = document.getElementById('repeatNoneBtn');
            const repeatOneBtn = document.getElementById('repeatOneBtn');
            const repeatAllBtn = document.getElementById('repeatAllBtn');
            const scanStatusDot = document.getElementById('scanStatusDot');
            const scanStatusText = document.getElementById('scanStatusText');
            const networkAddress = document.getElementById('networkAddress');
            const currentPlaylistName = document.getElementById('currentPlaylistName');
            
            // Modal elements
            const playlistModal = document.getElementById('playlistModal');
            const modalTitle = document.getElementById('modalTitle');
            const playlistNameInput = document.getElementById('playlistName');
            const imagePreview = document.getElementById('imagePreview');
            const imageUpload = document.getElementById('imageUpload');
            const uploadImageBtn = document.getElementById('uploadImageBtn');
            const cancelModalBtn = document.getElementById('cancelModalBtn');
            const savePlaylistBtn = document.getElementById('savePlaylistBtn');
            
            // Initialize player
            async function initPlayer() {
                // Get network address
                try {
                    const response = await fetch('/api/network-address');
                    const data = await response.json();
                    networkAddress.textContent = `Accessible at: ${data.address}:5000`;
                } catch (error) {
                    console.error('Error fetching network address:', error);
                }
                
                // Load initial state from server
                await loadPlayerState();
                
                // Set initial volume
                audio.volume = playerState.volume;
                volumeSlider.value = playerState.volume;
                
                // Set initial playback state
                updatePlayButton();
                
                // Set initial shuffle and repeat states
                updateShuffleButton();
                updateRepeatButton();
                
                // Load audio files
                await loadAudioFiles();
                
                // Load playlists
                await loadPlaylists();
                
                // If there's a current track, load it
                if (playerState.current_track) {
                    loadTrack(playerState.current_track);
                    audio.currentTime = playerState.current_time || 0;
                }
            }
            
            // Load player state from server
            async function loadPlayerState() {
                try {
                    const response = await fetch('/api/player-state');
                    const data = await response.json();
                    
                    playerState = {
                        shuffle: data.shuffle,
                        repeat: data.repeat,
                        volume: data.volume,
                        playbackState: data.playback_state
                    };
                    
                    currentPlaylistId = data.current_playlist_id;
                } catch (error) {
                    console.error('Error loading player state:', error);
                }
            }
            
            // Save player state to server
            async function savePlayerState() {
                try {
                    await fetch('/api/player-state', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            current_track: currentTrack,
                            current_time: audio.currentTime,
                            volume: playerState.volume,
                            shuffle: playerState.shuffle,
                            repeat: playerState.repeat,
                            playback_state: playerState.playbackState,
                            current_playlist_id: currentPlaylistId
                        })
                    });
                } catch (error) {
                    console.error('Error saving player state:', error);
                }
            }
            
            // Load audio files from server
            async function loadAudioFiles() {
                try {
                    scanStatusDot.classList.add('scanning');
                    scanStatusText.textContent = 'Scanning folder...';
                    
                    const response = await fetch('/api/audio-files');
                    audioFiles = await response.json();
                    
                    renderAudioLibrary();
                    
                    scanStatusDot.classList.remove('scanning');
                    scanStatusDot.style.background = 'var(--success)';
                    scanStatusText.textContent = `Scan complete: ${audioFiles.length} files found`;
                } catch (error) {
                    console.error('Error loading audio files:', error);
                    scanStatusDot.style.background = 'var(--error)';
                    scanStatusText.textContent = 'Error scanning folder';
                }
            }
            
            // Load playlists from server
            async function loadPlaylists() {
                try {
                    const response = await fetch('/api/playlists');
                    playlists = await response.json();
                    
                    renderPlaylists();
                    updatePlaylistCount();
                    
                    // Set current playlist if none is selected
                    if (!currentPlaylistId && playlists.length > 0) {
                        currentPlaylistId = playlists[0].id;
                        savePlayerState();
                    }
                    
                    // Render tracks for current playlist
                    renderTracks();
                } catch (error) {
                    console.error('Error loading playlists:', error);
                }
            }
            
            // Render audio library
            function renderAudioLibrary() {
                audioLibrary.innerHTML = '';
                
                audioFiles.forEach(file => {
                    const fileCard = document.createElement('div');
                    fileCard.className = 'file-card';
                    fileCard.dataset.path = file.path;
                    
                    fileCard.innerHTML = `
                        <div class="file-icon">
                            <i class="fas fa-file-audio"></i>
                        </div>
                        <div class="file-name">${file.title}</div>
                        <div class="file-info">
                            <span>${file.artist}</span>
                            <span>${formatFileSize(file.size)}</span>
                        </div>
                        <button class="add-to-playlist">
                            <i class="fas fa-plus"></i> Add to Playlist
                        </button>
                    `;
                    
                    audioLibrary.appendChild(fileCard);
                    
                    // Add event listener for adding to playlist
                    fileCard.querySelector('.add-to-playlist').addEventListener('click', () => {
                        if (currentPlaylistId) {
                            addToPlaylist(file.path, currentPlaylistId);
                        } else {
                            alert('Please select a playlist first');
                        }
                    });
                });
            }
            
            // Render playlists
            function renderPlaylists() {
                playlistList.innerHTML = '';
                
                playlists.forEach(playlist => {
                    const playlistItem = document.createElement('div');
                    playlistItem.className = `playlist-item ${currentPlaylistId === playlist.id ? 'active' : ''}`;
                    playlistItem.dataset.id = playlist.id;
                    
                    playlistItem.innerHTML = `
                        <div class="playlist-item-image" style="${playlist.image ? `background-image: url('data:image/jpeg;base64,${playlist.image}')` : ''}">
                            ${playlist.image ? '' : '<i class="fas fa-music"></i>'}
                        </div>
                        <div class="playlist-item-info">
                            <div class="playlist-item-name">${playlist.name}</div>
                            <div class="playlist-item-track-count">${playlist.tracks.length} tracks</div>
                        </div>
                    `;
                    
                    playlistList.appendChild(playlistItem);
                    
                    // Add event listener
                    playlistItem.addEventListener('click', () => {
                        selectPlaylist(playlist.id);
                    });
                });
            }
            
            // Render tracks in current playlist
            function renderTracks() {
                tracksContainer.innerHTML = '';
                
                const playlist = playlists.find(p => p.id === currentPlaylistId);
                if (!playlist) return;
                
                currentPlaylistName.textContent = playlist.name;
                
                playlist.tracks.forEach((trackPath, index) => {
                    const track = audioFiles.find(f => f.path === trackPath);
                    if (!track) return;
                    
                    const trackItem = document.createElement('div');
                    trackItem.className = `track-item ${currentTrack === trackPath ? 'active' : ''}`;
                    trackItem.dataset.index = index;
                    trackItem.draggable = true;
                    
                    trackItem.innerHTML = `
                        <div class="drag-handle">
                            <i class="fas fa-grip-lines"></i>
                        </div>
                        <div class="track-item-art">
                            <i class="fas fa-music"></i>
                        </div>
                        <div class="track-item-info">
                            <div class="track-item-title">${track.title}</div>
                            <div class="track-item-artist">${track.artist}</div>
                        </div>
                        <div class="track-item-duration">${track.duration}</div>
                        <div class="track-item-actions">
                            <div class="action-icon remove-from-playlist" title="Remove from playlist">
                                <i class="fas fa-times"></i>
                            </div>
                            <div class="action-icon play-now" title="Play now">
                                <i class="fas fa-play"></i>
                            </div>
                        </div>
                    `;
                    
                    tracksContainer.appendChild(trackItem);
                    
                    // Add event listeners
                    trackItem.querySelector('.remove-from-playlist').addEventListener('click', (e) => {
                        e.stopPropagation();
                        removeFromPlaylist(index, playlist.id);
                    });
                    
                    trackItem.querySelector('.play-now').addEventListener('click', (e) => {
                        e.stopPropagation();
                        playTrack(index);
                    });
                    
                    trackItem.addEventListener('click', () => {
                        playTrack(index);
                    });
                    
                    // Drag and drop for reordering
                    trackItem.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', index);
                        trackItem.classList.add('dragging');
                    });
                    
                    trackItem.addEventListener('dragend', () => {
                        trackItem.classList.remove('dragging');
                    });
                });
                
                // Add drop zone for reordering
                tracksContainer.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(tracksContainer, e.clientY);
                    const draggable = document.querySelector('.dragging');
                    if (afterElement) {
                        tracksContainer.insertBefore(draggable, afterElement);
                    } else {
                        tracksContainer.appendChild(draggable);
                    }
                });
                
                tracksContainer.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                    const trackItems = Array.from(tracksContainer.children);
                    const toIndex = trackItems.findIndex(item => item.classList.contains('dragging'));
                    
                    if (fromIndex !== toIndex) {
                        moveInPlaylist(fromIndex, toIndex);
                    }
                });
            }
            
            // Helper for drag and drop
            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.track-item:not(.dragging)')];
                
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }
            
            // Select a playlist
            function selectPlaylist(playlistId) {
                currentPlaylistId = playlistId;
                savePlayerState();
                renderPlaylists();
                renderTracks();
            }
            
            // Add track to playlist
            async function addToPlaylist(trackPath, playlistId) {
                try {
                    const response = await fetch(`/api/playlists/${playlistId}/tracks`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            track_path: trackPath
                        })
                    });
                    
                    if (response.ok) {
                        await loadPlaylists();
                    }
                } catch (error) {
                    console.error('Error adding track to playlist:', error);
                }
            }
            
            // Remove track from playlist
            async function removeFromPlaylist(index, playlistId) {
                try {
                    const response = await fetch(`/api/playlists/${playlistId}/tracks/${index}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        await loadPlaylists();
                        
                        // If the removed track was playing, stop it
                        const playlist = playlists.find(p => p.id === playlistId);
                        if (playlist && currentTrack === playlist.tracks[index]) {
                            audio.pause();
                            playerState.playbackState = 'paused';
                            currentTrack = null;
                            currentTrackIndex = -1;
                            updatePlayButton();
                            updateNowPlaying();
                        }
                    }
                } catch (error) {
                    console.error('Error removing track from playlist:', error);
                }
            }
            
            // Move track in playlist
            async function moveInPlaylist(fromIndex, toIndex) {
                // This would require a new endpoint on the backend
                // For simplicity, we'll just reload the playlist
                await loadPlaylists();
            }
            
            // Update playlist count display
            function updatePlaylistCount() {
                playlistCount.textContent = playlists.length;
            }
            
            // Play track by index
            function playTrack(index) {
                const playlist = playlists.find(p => p.id === currentPlaylistId);
                if (!playlist) return;
                
                if (index >= 0 && index < playlist.tracks.length) {
                    currentTrackIndex = index;
                    currentTrack = playlist.tracks[index];
                    loadTrack(currentTrack);
                    playAudio();
                }
            }
            
            // Load track into player
            function loadTrack(trackPath) {
                const track = audioFiles.find(f => f.path === trackPath);
                if (track) {
                    audio.src = `/api/audio/${encodeURIComponent(track.filename)}`;
                    currentSongTitle.textContent = track.title;
                    currentSongArtist.textContent = track.artist;
                    durationDisplay.textContent = track.duration;
                    
                    // Update album art
                    albumArt.style.backgroundImage = "linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c)";
                    
                    // Update active item in playlist
                    renderTracks();
                    
                    // Save state
                    savePlayerState();
                }
            }
            
            // Play audio
            function playAudio() {
                audio.play()
                    .then(() => {
                        playerState.playbackState = 'playing';
                        updatePlayButton();
                        savePlayerState();
                    })
                    .catch(error => {
                        console.error('Error playing audio:', error);
                    });
            }
            
            // Pause audio
            function pauseAudio() {
                audio.pause();
                playerState.playbackState = 'paused';
                updatePlayButton();
                savePlayerState();
            }
            
            // Update play/pause button
            function updatePlayButton() {
                const icon = playBtn.querySelector('i');
                if (playerState.playbackState === 'playing') {
                    icon.classList.remove('fa-play');
                    icon.classList.add('fa-pause');
                    playBtn.classList.add('playing');
                } else {
                    icon.classList.remove('fa-pause');
                    icon.classList.add('fa-play');
                    playBtn.classList.remove('playing');
                }
            }
            
            // Update shuffle button
            function updateShuffleButton() {
                shuffleBtn.style.color = playerState.shuffle ? 'var(--accent-primary)' : 'var(--text-primary)';
            }
            
            // Update repeat button
            function updateRepeatButton() {
                repeatBtn.innerHTML = '';
                if (playerState.repeat === 'one') {
                    repeatBtn.innerHTML = '<i class="fas fa-repeat-1"></i>';
                } else {
                    repeatBtn.innerHTML = '<i class="fas fa-repeat"></i>';
                }
                
                repeatBtn.style.color = playerState.repeat !== 'none' ? 'var(--accent-primary)' : 'var(--text-primary)';
                
                // Update mode buttons
                repeatNoneBtn.classList.toggle('active', playerState.repeat === 'none');
                repeatOneBtn.classList.toggle('active', playerState.repeat === 'one');
                repeatAllBtn.classList.toggle('active', playerState.repeat === 'all');
            }
            
            // Toggle shuffle
            function toggleShuffle() {
                playerState.shuffle = !playerState.shuffle;
                updateShuffleButton();
                savePlayerState();
            }
            
            // Cycle through repeat modes
            function cycleRepeatMode() {
                const modes = ['none', 'one', 'all'];
                const currentIndex = modes.indexOf(playerState.repeat);
                playerState.repeat = modes[(currentIndex + 1) % modes.length];
                updateRepeatButton();
                savePlayerState();
            }
            
            // Go to next track
            async function nextTrack() {
                try {
                    const response = await fetch('/api/next-track');
                    const data = await response.json();
                    
                    if (data.next_track) {
                        currentTrack = data.next_track;
                        currentTrackIndex = data.current_index;
                        loadTrack(currentTrack);
                        playAudio();
                    } else if (data.end_of_playlist) {
                        // End of playlist
                        pauseAudio();
                    }
                } catch (error) {
                    console.error('Error getting next track:', error);
                }
            }
            
            // Go to previous track
            async function previousTrack() {
                try {
                    const response = await fetch('/api/previous-track');
                    const data = await response.json();
                    
                    if (data.prev_track) {
                        if (data.restart) {
                            // Restart current track
                            audio.currentTime = 0;
                            savePlayerState();
                        } else {
                            currentTrack = data.prev_track;
                            currentTrackIndex = data.current_index;
                            loadTrack(currentTrack);
                            playAudio();
                        }
                    }
                } catch (error) {
                    console.error('Error getting previous track:', error);
                }
            }
            
            // Format file size for display
            function formatFileSize(size) {
                if (size < 1024) return size + ' B';
                else if (size < 1048576) return (size / 1024).toFixed(1) + ' KB';
                else if (size < 1073741824) return (size / 1048576).toFixed(1) + ' MB';
                else return (size / 1073741824).toFixed(1) + ' GB';
            }
            
            // Update now playing info
            function updateNowPlaying() {
                if (!currentTrack) {
                    currentSongTitle.textContent = 'Select a song to play';
                    currentSongArtist.textContent = '';
                    durationDisplay.textContent = '0:00';
                    progressBar.style.width = '0%';
                    currentTimeDisplay.textContent = '0:00';
                    albumArt.style.backgroundImage = "linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c)";
                }
            }
            
            // Open playlist modal
            function openPlaylistModal(playlistId = null) {
                playlistNameInput.value = '';
                imagePreview.style.backgroundImage = '';
                imagePreview.innerHTML = '<i class="fas fa-image"></i>';
                
                if (playlistId) {
                    // Edit existing playlist
                    const playlist = playlists.find(p => p.id === playlistId);
                    if (playlist) {
                        modalTitle.textContent = 'Edit Playlist';
                        playlistNameInput.value = playlist.name;
                        
                        if (playlist.image) {
                            imagePreview.style.backgroundImage = `url('data:image/jpeg;base64,${playlist.image}')`;
                            imagePreview.innerHTML = '';
                        }
                    }
                } else {
                    // Create new playlist
                    modalTitle.textContent = 'New Playlist';
                }
                
                playlistModal.dataset.id = playlistId || '';
                playlistModal.style.display = 'flex';
            }
            
            // Close playlist modal
            function closePlaylistModal() {
                playlistModal.style.display = 'none';
            }
            
            // Event listeners
            playBtn.addEventListener('click', () => {
                if (!currentTrack && currentPlaylistId) {
                    playTrack(0);
                } else if (playerState.playbackState === 'playing') {
                    pauseAudio();
                } else if (currentTrack) {
                    playAudio();
                }
            });
            
            prevBtn.addEventListener('click', previousTrack);
            nextBtn.addEventListener('click', nextTrack);
            shuffleBtn.addEventListener('click', toggleShuffle);
            repeatBtn.addEventListener('click', cycleRepeatMode);
            
            repeatNoneBtn.addEventListener('click', () => {
                playerState.repeat = 'none';
                updateRepeatButton();
                savePlayerState();
            });
            
            repeatOneBtn.addEventListener('click', () => {
                playerState.repeat = 'one';
                updateRepeatButton();
                savePlayerState();
            });
            
            repeatAllBtn.addEventListener('click', () => {
                playerState.repeat = 'all';
                updateRepeatButton();
                savePlayerState();
            });
            
            volumeSlider.addEventListener('input', () => {
                playerState.volume = parseFloat(volumeSlider.value);
                audio.volume = playerState.volume;
                savePlayerState();
            });
            
            progressBarContainer.addEventListener('click', (e) => {
                if (!currentTrack) return;
                
                const width = progressBarContainer.clientWidth;
                const clickX = e.offsetX;
                const percent = (clickX / width);
                progressBar.style.width = `${percent * 100}%`;
                
                // Set audio time
                audio.currentTime = percent * audio.duration;
                updateTimeDisplay();
                savePlayerState();
            });
            
            // Update time display
            function updateTimeDisplay() {
                if (!currentTrack) return;
                
                const currentTime = audio.currentTime;
                const minutes = Math.floor(currentTime / 60);
                const seconds = Math.floor(currentTime % 60);
                currentTimeDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                
                // Update progress bar
                const percent = (currentTime / audio.duration) * 100;
                progressBar.style.width = `${percent}%`;
            }
            
            // Audio event listeners
            audio.addEventListener('timeupdate', () => {
                updateTimeDisplay();
            });
            
            audio.addEventListener('ended', () => {
                if (playerState.repeat === 'one') {
                    audio.currentTime = 0;
                    audio.play();
                } else {
                    nextTrack();
                }
            });
            
            audio.addEventListener('loadedmetadata', () => {
                const minutes = Math.floor(audio.duration / 60);
                const seconds = Math.floor(audio.duration % 60);
                durationDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            });
            
            // Playlist actions
            createPlaylistBtn.addEventListener('click', () => {
                openPlaylistModal();
            });
            
            renamePlaylistBtn.addEventListener('click', () => {
                if (currentPlaylistId) {
                    openPlaylistModal(currentPlaylistId);
                }
            });
            
            deletePlaylistBtn.addEventListener('click', () => {
                if (currentPlaylistId && confirm('Are you sure you want to delete this playlist?')) {
                    deletePlaylist(currentPlaylistId);
                }
            });
            
            addAllBtn.addEventListener('click', () => {
                if (currentPlaylistId) {
                    audioFiles.forEach(file => {
                        addToPlaylist(file.path, currentPlaylistId);
                    });
                }
            });
            
            clearPlaylistBtn.addEventListener('click', () => {
                if (currentPlaylistId && confirm('Are you sure you want to clear this playlist?')) {
                    const playlist = playlists.find(p => p.id === currentPlaylistId);
                    if (playlist) {
                        playlist.tracks = [];
                        savePlaylist(playlist);
                    }
                }
            });
            
            // Modal actions
            uploadImageBtn.addEventListener('click', () => {
                imageUpload.click();
            });
            
            imageUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        imagePreview.style.backgroundImage = `url('${event.target.result}')`;
                        imagePreview.innerHTML = '';
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            cancelModalBtn.addEventListener('click', closePlaylistModal);
            
            savePlaylistBtn.addEventListener('click', async () => {
                const name = playlistNameInput.value.trim();
                if (!name) {
                    alert('Please enter a playlist name');
                    return;
                }
                
                const playlistId = playlistModal.dataset.id;
                const file = imageUpload.files[0];
                
                if (playlistId) {
                    // Update existing playlist
                    try {
                        // Update name
                        const response = await fetch(`/api/playlists/${playlistId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                name: name
                            })
                        });
                        
                        if (file) {
                            const formData = new FormData();
                            formData.append('image', file);
                            
                            const uploadResponse = await fetch(`/api/playlists/${playlistId}/image`, {
                                method: 'POST',
                                body: formData
                            });
                            
                            if (!uploadResponse.ok) {
                                throw new Error('Failed to upload image');
                            }
                        }
                        
                        await loadPlaylists();
                        closePlaylistModal();
                    } catch (error) {
                        console.error('Error updating playlist:', error);
                        alert('Failed to update playlist');
                    }
                } else {
                    // Create new playlist
                    try {
                        const response = await fetch('/api/playlists', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                name: name
                            })
                        });
                        
                        const newPlaylist = await response.json();
                        
                        if (file) {
                            const formData = new FormData();
                            formData.append('image', file);
                            
                            const uploadResponse = await fetch(`/api/playlists/${newPlaylist.id}/image`, {
                                method: 'POST',
                                body: formData
                            });
                            
                            if (!uploadResponse.ok) {
                                throw new Error('Failed to upload image');
                            }
                        }
                        
                        await loadPlaylists();
                        closePlaylistModal();
                    } catch (error) {
                        console.error('Error creating playlist:', error);
                        alert('Failed to create playlist');
                    }
                }
            });
            
            // Delete playlist
            async function deletePlaylist(playlistId) {
                try {
                    const response = await fetch(`/api/playlists/${playlistId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        await loadPlaylists();
                    }
                } catch (error) {
                    console.error('Error deleting playlist:', error);
                }
            }
            
            // Save playlist to server
            async function savePlaylist(playlist) {
                try {
                    await fetch(`/api/playlists/${playlist.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: playlist.name
                        })
                    });
                } catch (error) {
                    console.error('Error saving playlist:', error);
                }
            }
            
            // Initialize the player
            initPlayer();
        });
    </script>
</body>
</html>